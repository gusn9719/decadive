<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="dao.CartDAO">

	<!-- 장바구니 + 상품 조인 공통 SQL -->
	<sql id="cartSelectBase">
		SELECT
		d.cart_item_no AS cartItemNo,
		d.cart_no AS cartNo,
		d.item_no AS itemNo,
		d.quantity AS quantity,
		m.member_id AS memberId,
		i.name AS itemName,
		i.price AS price,
		i.image_path AS imagePath,
		id.description AS description
		FROM deca_cart_d d
		JOIN deca_cart_m m ON d.cart_no = m.cart_no
		JOIN deca_item i ON d.item_no = i.item_no
		LEFT JOIN deca_item_detail id ON id.item_no = i.item_no
	</sql>

	<!-- memberId로 cart_no 조회 -->
	<select id="selectCartNoByMemberId" parameterType="string"
		resultType="int">
		SELECT cart_no
		FROM deca_cart_m
		WHERE member_id = #{memberId}
	</select>

	<!-- 새 cart_no 발급용 -->
	<select id="nextCartNo" resultType="int">
		SELECT
		SEQ_DECA_CART_NO.NEXTVAL FROM dual
	</select>

	<!-- 장바구니 마스터 생성 -->
	<insert id="insertCartMaster" parameterType="map">
		INSERT INTO
		deca_cart_m (cart_no, member_id, created_at)
		VALUES (#{cartNo},
		#{memberId}, SYSDATE)
	</insert>

	<!-- 장바구니 목록 조회 (회원별) -->
	<select id="selectCartItemsByMemberId" parameterType="string"
		resultType="cartItemVO">
		<include refid="cartSelectBase" />
		WHERE m.member_id = #{memberId}
		ORDER BY d.added_at DESC
	</select>

	<!-- 특정 상품이 이미 장바구니에 있는지 확인 -->
	<select id="selectCartItemQty" parameterType="map"
		resultType="int">
		SELECT quantity
		FROM deca_cart_d
		WHERE cart_no = #{cartNo}
		AND item_no = #{itemNo}
	</select>

	<!-- 새 장바구니 아이템 추가 -->
	<insert id="insertCartItem" parameterType="map">
		INSERT INTO
		deca_cart_d (
		cart_item_no, cart_no, item_no, quantity, added_at
		)
		VALUES (
		SEQ_DECA_CART_ITEM_NO.NEXTVAL,
		#{cartNo},
		#{itemNo},
		#{quantity},
		SYSDATE
		)
	</insert>

	<!-- 이미 있으면 수량 + ? -->
	<update id="updateCartItemAddQty" parameterType="map">
		UPDATE
		deca_cart_d
		SET quantity = quantity + #{quantity}
		WHERE cart_no =
		#{cartNo}
		AND item_no = #{itemNo}
	</update>

	<!-- 수량 수정 -->
	<update id="updateCartItemQty" parameterType="map">
		UPDATE deca_cart_d
		SET quantity = #{quantity}
		WHERE cart_item_no = #{cartItemNo}
	</update>

	<!-- 한 품목 삭제 -->
	<delete id="deleteCartItem" parameterType="int">
		DELETE FROM
		deca_cart_d
		WHERE cart_item_no = #{cartItemNo}
	</delete>

	<!-- 장바구니 비우기 (회원 기준) -->
	<delete id="clearCartByMemberId" parameterType="string">
		DELETE FROM
		deca_cart_d
		WHERE cart_no IN (
		SELECT cart_no
		FROM deca_cart_m
		WHERE
		member_id = #{memberId}
		)
	</delete>

</mapper>
